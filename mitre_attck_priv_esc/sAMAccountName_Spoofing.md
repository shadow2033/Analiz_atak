# Правило sAMAccountName_Spoofing

"sAMAccountName_Spoofing" — это атака, которая злоумышленнику позволяет подделывать sAMAccountName (Security Account Manager Account Name) машинных аккаунтов в Active Directory. Машинные аккаунты в Windows обычно завершаются символом "$" в конце имени. Однако, в некоторых случаях механизмы Active Directory не проверяют наличие этого символа, что создает уязвимость.

## Методы атаки:

### CVE-2021-42278 и CVE-2021-42287

Эти уязвимости позволяют злоумышленнику изменить имя машинного аккаунта (убрать символ "$"), запросить для него Ticket Granting Ticket (TGT), а затем восстановить символ "$" в имени машинного аккаунта. При запросе сервисного билета (TGS) KDC (Key Distribution Center) добавит символ "$" к имени машинного аккаунта, даже если он был удален. Это позволяет злоумышленнику получить TGS на машинный аккаунт и, теоретически, находиться в контроле над контроллером домена.

### Изменение атрибутов машинного аккаунта

Если у злоумышленника есть права на изменение атрибутов машинного аккаунта (например, через привилегии создания машинных аккаунтов), он может изменить атрибут "sAMAccountName" машинного аккаунта и удалить символ "$". Затем он может запросить TGT для машинного аккаунта без символа "$" и, таким образом, получить TGS на машинный аккаунт.

## Цель атаки:

1. Получение доступа к машинному аккаунту и, теоретически, контролю над компьютером в домене.

2. Подделка машинного аккаунта для получения сервисного билета (TGS) на другие аккаунты или службы в домене, что может привести к повышению привилегий и расширению атаки внутри домена.

## Описание правила

Правило "sAMAccountName_Spoofing" направлено на отслеживание изменений в аккаунтах компьютеров, у которых отсутствует символ "$" в имени. Это может представлять потенциальную уязвимость, связанную с атакой "sAMAccountName_Spoofing".

### Событие "event Computer_Account_without_Dollar"

- **key:** Ключ события формируется на основе двух параметров: хост, на котором произошло событие (event_src.host), и имя аккаунта компьютера (object.account.name).

- **filter:** Условия фильтрации:
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `event_src.title == "windows"`: Фильтрует события, связанные только с операционной системой Windows.
  - `msgid == "4742"`: Ожидает события с определенным идентификатором сообщения.
  - `not match(object.account.name, "*$")`: Проверяет, что имя аккаунта компьютера не оканчивается на символ "$". Это условие идентифицирует аккаунты компьютеров, у которых отсутствует символ "$" в имени, что может означать потенциальную уязвимость.

### Событие "event TGT_For_Spoofed_Account"

- **key:** Ключ события формируется на основе двух параметров: хост, на котором произошло событие (event_src.host) и имя аккаунта субъекта (subject.account.name).

- **filter:** Условия фильтрации:
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `event_src.title == "windows"`: Фильтрует события, связанные только с операционной системой Windows.
  - `msgid == "4768"`: Ожидает события с определенным идентификатором сообщения.
