# Правило Unquoted_Service_Path_Abuse

Атака "Unquoted_Service_Path_Abuse" направлена на злоумышленное использование уязвимостей в конфигурации служб Windows, которые не заключают в кавычки путь к исполняемому файлу службы и содержат пробелы в пути. Это основано на том, как Windows обрабатывает вызовы API CreateProcess. Если путь к исполняемому файлу службы не заключен в кавычки и содержит пробелы, это может создать ситуацию, в которой Windows выберет исполняемый файл, предложенный злоумышленником, для запуска службы.

## Методы атаки:

1. **Не заключенный в кавычки путь службы:** Атакующий определяет службу, которая использует путь к исполняемому файлу без кавычек и содержащий пробелы. Затем он размещает свой зловредный исполняемый файл в более высоком уровне каталога в пути службы. Когда служба запускается, Windows выбирает исполняемый файл атакующего вместо ожидаемого.

2. **Интерсептация путей в ярлыках:** Атакующий может также использовать уязвимость в путях, хранящихся в ярлыках, если путь содержит пробелы и не заключен в кавычки. Атакующий создает свой зловредный исполняемый файл в более высоком уровне каталога, чем ожидаемый исполняемый файл, и когда ярлык запускается, Windows выполнит зловредный файл атакующего вместо ожидаемого.

## Цель атаки:

1. **Постоянство:** Злоумышленники могут использовать эту атаку для обеспечения постоянства в системе, если исполняемые файлы вызываются регулярно, например, как часть запуска службы.

2. **Повышение привилегий:** Если атакующий может перехватить выполнение исполняемых файлов, запущенных более привилегированным процессом, это может привести к повышению привилегий и получению более широкого доступа к системе.

## Описание правила

Правило "Unquoted_Service_Path_Abuse" предназначено для обнаружения запуска процессов на системе Windows, применяя различные условия для фильтрации. Основной целью является выявление процессов, запущенных службой Windows ("services.exe") и процессов, запущенных с использованием пробелов в командной строке.

### Событие "event Process_Start":

- **key:** Формируется на основе хоста (event_src.host)
- **filter:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `filter::ProcessStart_Windows_any()`: Фильтр, который применяется для событий запуска процессов на системах Windows.

- Проверка наличия пробелов в командной строке запускаемого процесса:
  - `match(lower(object.process.cmdline), strip(lower(object.process.fullpath), "", ".exe") + " *")`: Этот фильтр срабатывает, если для атаки использован первый пробел в строке командной строки.
  - `match(lower(object.process.cmdline), '"' + strip(lower(object.process.fullpath), "", ".exe") + '" *')`: Этот фильтр срабатывает, если для атаки использован второй или следующие пробелы в строке командной строки, так как система неявно добавляет кавычки вокруг пути к исполняемому файлу.
  - `object.process.parent.fullpath == "c:\windows\system32\services.exe"`: Фильтр проверяет, что родительский процесс запускаемого процесса - "services.exe" в системной директории Windows.
