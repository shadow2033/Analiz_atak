# Правило CreateProcessAsUser_Impersonation

Атакующие могут использовать функции LogonUser() и CreateProcessAsUser() из библиотеки Advapi32.dll для запуска дочерних процессов в контексте другого пользователя. Это позволяет атакующим выполнить действия от имени другого пользователя, обойдя ограничения доступа и повысив свои привилегии.

## Методы атаки:

1. **LogonUser() и CreateProcessAsUser():** Атакующие могут использовать функцию LogonUser() для аутентификации с учетными данными другого пользователя. Затем они могут использовать функцию CreateProcessAsUser() для создания нового процесса в контексте этого пользователя. Это позволяет атакующим выполнять операции, к которым они не имеют прав доступа в своем собственном контексте.

2. **DuplicateToken и ImpersonateLoggedOnUser:** Для атаки на существующий процесс, атакующие могут продублировать существующий токен (например, с помощью DuplicateToken или DuplicateTokenEx) и затем использовать ImpersonateLoggedOnUser для возвышения привилегий и маскировки под другого пользователя. Это позволяет атакующим обойти множество механизмов обеспечения безопасности.

## Цель атаки:

Целью атаки "CreateProcessAsUser_Impersonation" является выполнение операций с повышенными привилегиями или обход ограничений доступа, путем запуска дочерних процессов в контексте другого пользователя. Атакующие могут использовать эту атаку для выполнения действий, к которым у них нет прав доступа в собственном контексте, или для повышения своих привилегий на целевой системе.

## Описание правила

Правило "CreateProcessAsUser_Impersonation" анализирует события, связанные с попытками и успешными входами в систему (логинами) на уровне учетных записей (аккаунтов) и активацией привилегий в среде Windows. Оно может помочь выявить подозрительную активность, связанную с поднятием привилегий и несанкционированными входами в систему.

### Событие "Account_LogonAttempt":

**key:** Ключ формируется на основе нескольких параметров:
- `event_src.host`: Хост, на котором произошло событие.
- `subject.account.name`: Имя учетной записи субъекта.
- `subject.process.id`: Идентификатор процесса субъекта.
- `object.account.name`: Имя учетной записи объекта.

**filter:**
- `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
- `event_src.title == "windows"`: Событие должно иметь заголовок "windows".
- `msgid == "4648"`: Идентификатор сообщения должен быть равен "4648".
- `lower(object) == "account"`: Объектом события должна быть учетная запись.
- `lower(action) == "elevate"`: Действие должно быть "elevate", что указывает на попытку повышения привилегий.
- `subject.account.name != object.account.name`: Имя учетной записи субъекта и объекта не должны совпадать.
- `in_list(["winlogon.exe", "wininit.exe"], lower(subject.process.name)) == False`: Имя процесса субъекта не должно соответствовать определенным значениям, что помогает избежать ложных срабатываний.
- `in_list(["localhost", event_src.hostname], dst.hostname)`: Проверяется соответствие хостов (или локального хоста) между источником (source) и целью (destination).

### Событие "Account_LogonSuccess":

**key:** Ключ формируется на основе нескольких параметров:
- `event_src.host`: Хост, на котором произошло событие.
- `subject.account.name`: Имя учетной записи субъекта.
- `subject.process.id`: Идентификатор процесса субъекта.
- `object.account.name`: Имя учетной записи объекта.

**filter:**
- `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
- `event_src.title == "windows"`: Событие должно иметь заголовок "windows".
- `msgid == "4624"`: Идентификатор сообщения должен быть равен "4624".
- `in_list([2, 3], logon_type)`: Тип входа в систему должен соответствовать значениям 2 или 3 .
- `lower(object) == "account"`: Объектом события должна быть учетная запись.
- `lower(action) == "elevate"`: Действие должно быть "elevate", что указывает на попытку повышения привилегий.
- `subject.account.name != object.account.name`: Имя учетной записи субъекта и объекта не должны совпадать.
- `lower(logon_service) == "advapi"`: Служба входа в систему должна быть "advapi", что указывает на использование функций LogonUser() и CreateProcessAsUser().
- `in_list(["winlogon.exe", "wininit.exe"], subject.process.name) == False`: Имя процесса субъекта не должно соответствовать определенным значениям, что помогает избежать ложных срабатываний.
