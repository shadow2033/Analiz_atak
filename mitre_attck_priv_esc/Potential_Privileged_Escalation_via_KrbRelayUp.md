# Правило Potential_Privileged_Escalation_via_KrbRelayUp

Атака "Potential_Privileged_Escalation_via_KrbRelayUp" представляет собой потенциальную попытку повышения привилегий в среде Windows, используя атаку Kerberos Relay (KrbRelay) на уязвимую систему. Атакующие могут попытаться выполнить следующие действия:

1. **Локальный успешный вход в систему с использованием Kerberos:** Атака начинается с успешного входа в систему, при этом используется протокол Kerberos. Важно отметить, что протокол Kerberos широко используется для аутентификации в средах Windows.

2. **Удаленный адрес установлен на localhost:** Важным признаком атаки является то, что удаленный адрес (remote address) установлен на localhost (127.0.0.1). Это означает, что атакующие пытаются использовать локальный компьютер в качестве промежуточной точки для атаки.

3. **Целевой пользовательский SID - встроенная учетная запись локального администратора:** Атака направлена на локальную встроенную учетную запись администратора (builtin local Administrator account). Эта учетная запись обычно обладает высокими привилегиями на локальной системе.

4. **Попытка использования Kerberos Relay:** В целях повышения привилегий атакующие могут использовать атаку Kerberos Relay, что может позволить им выполнить привилегированные действия на целевой системе.

## Методы атаки:

Атака использует несколько методов для выполнения атаки, включая:

- **New machine account creation (New-MachineAccount):** Возможность создания новой учетной записи компьютера на целевой системе.

- **Local machine account auth coercion (KrbRelay):** Захват учетных данных локальной учетной записи компьютера и их использование для аутентификации на других системах.

- **Kerberos relay to LDAP (KrbRelay):** Использование атаки KrbRelay для выполнения аутентификации на службе LDAP на другой системе.

- **Add RBCD privs and obtain privileged ST to local machine (Rubeus):** Попытка получения привилегированного сервисного билета (TGT) и использование его для повышения привилегий на локальной машине.

- **Using said ST to authenticate to local Service Manager and create a new service as NT/SYSTEM (SCMUACBypass):** Использование полученного сервисного билета для аутентификации в локальном Service Manager и создания новой службы с привилегиями NT/SYSTEM.

## Цель атаки:

Целью атаки "Potential_Privileged_Escalation_via_KrbRelayUp" является выполнение повышения привилегий на целевой системе. Это означает, что злоумышленники стремятся получить наивысшие уровни доступа и контроля над операционной системой, на которой выполняется атака. В контексте операционных систем Windows, наивысший уровень доступа соответствует привилегиям NT/SYSTEM.

## Описание правила

Правило "Potential_Privileged_Escalation_via_KrbRelayUp" мониторинга для обнаружения локальных входов в систему в роли локального администратора на хосте с указанными характеристиками.

### Событие "Local_Admin_Login"

- **key:** Формируется на основе хоста (event_src.host).

- **filter:**
  - `filter::NotFromCorrelator()`: Этот фильтр исключает события, созданные коррелятором.
  - `event_src.title == "windows"`: Событие должно иметь заголовок "windows", что указывает на то, что оно относится к операционной системе Windows.
  - `msgid == "4624"`: Идентификатор сообщения (msgid) должен быть равен "4624". Этот идентификатор обычно используется для событий успешного входа в систему.
  - `logon_type == 3`: Тип входа в систему (logon_type) должен быть равен 3, что соответствует сетевому (network) входу в систему.
  - `src.ip == "127.0.0.1"`: IP-адрес источника входа должен быть равен "127.0.0.1", что указывает на локальный вход.
  - `logon_service == "Kerberos"`: Служба аутентификации (logon_service) должна быть "Kerberos", что указывает на использование протокола Kerberos для аутентификации.
  - `match(subject.account.id, "S-1-5-21-*-500")`: Идентификатор учетной записи (subject.account.id) должен соответствовать шаблону "S-1-5-21-*-500", что обычно указывает на локального администратора (пользователь с SID, заканчивающимся на 500).
