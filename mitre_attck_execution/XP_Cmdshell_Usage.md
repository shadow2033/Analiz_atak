# Правило XP_Cmdshell_Usage

Атакующие могут использовать функцию в Microsoft SQL Server для выполнения операций командной оболочки на системе, где запущен SQL Server. Это предоставляет им доступ к командному интерфейсу операционной системы и позволяет выполнять команды с теми же правами, что и учетная запись службы SQL Server.

### Методы атаки:

1. **Включение `xp_cmdshell`:** Злоумышленники могут попытаться включить функцию `xp_cmdshell` на сервере SQL, если она отключена по умолчанию. Это может быть сделано через управление на основе политик или выполнение `sp_configure`. Как только функция `xp_cmdshell` активирована, злоумышленники могут использовать ее для выполнения команд на операционной системе сервера.

2. **Выполнение команд:** После включения, злоумышленники могут использовать эту функцию для выполнения команд на операционной системе, где работает SQL Server. Это может включать в себя выполнение команд для получения информации о системе, создания или удаления файлов, а также другие операции командной строки.

### Цель атаки:

Целью атаки "XP_Cmdshell_Usage" является выполнение команд на уровне операционной системы сервера SQL. Злоумышленники могут использовать это для различных целей, таких как:

- Загрузка вредоносных программ или скриптов на сервер.
- Изменение файловой системы сервера.
- Получение доступа к конфиденциальным данным и базам данных.
- Использование сервера в качестве платформы для атак на другие системы.

## Описание правила

Правило "XP_Cmdshell_Usage" направлено на обнаружение событий, связанных с использованием функции 'xp_cmdshell' в Microsoft SQL Server.

- **key:** Группируется по хосту, на котором произошло событие.

- **filter:**

  - `filter::NotFromCorrelator()`: Этот фильтр исключает события, созданные из коррелятора.
  - `event_src.title == "sql_server"`: Событие ожидается связанным с SQL Server, и это фильтрует только события, связанные с SQL Server.
  - `msgid == "33205"`: Этот фильтр проверяет, что сообщение имеет ID 33205, что, возможно, является идентификатором для событий, связанных с попытками использования `xp_cmdshell`.
  - `object == "command"`: Фильтр применяется к объектам с типом "command".
  - `match(lower(object.query), "xp_cmdshell")`: Этот фильтр проверяет, что текст запроса (`object.query`), преобразованный в нижний регистр, содержит фразу "xp_cmdshell".
