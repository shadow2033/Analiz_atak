# Правило  VSSVC_service_state_changed 

Атака "VSSVC_service_state_changed" связана с злоупотреблением службой теневого копирования (VSS) для получения учетных данных (OS Credential Dumping) или препятствия восстановлению данных (Inhibit System Recovery). Успешное выполнение атаки включает в себя запуск службы теневого копирования томов (VSS).

## Методы атаки:

1. **Использование Vshadow:** Атакующие могут использовать утилиту Vshadow для создания теневых копий томов. Vshadow предоставляет доступ к данным, которые могут содержать учетные данные, например, файлы системных резервных копий.

2. **Изменение состояния службы VSS:** Атакующие могут изменять состояние службы теневого копирования (VSS) с целью либо отключить ее, что препятствует созданию теневых копий, либо запустить ее, чтобы получить доступ к данным.

## Цель атаки:

- **Получение учетных данных (OS Credential Dumping):** Атакующие могут использовать атаку на службу теневого копирования для доступа к данным, содержащим учетные записи и пароли пользователей.

- **Препятствие восстановлению данных (Inhibit System Recovery):** Злоумышленники могут использовать атаку, чтобы предотвратить или затруднить восстановление данных и системы после инцидента.

## Описание правила

Правило "VSSVC_service_state_changed" мониторит активность службы теневого копирования (VSS) и связанные с ней процессы на хосте события.

### 1. Событие Process_Start:

- **key:** Группируется по хосту, на котором произошло событие.

- **filter:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные коррелятором.
  - `in_list(["4688", "1"], msgid)`: `msgid` включает значения "4688" (запуск процесса) и "1" (событие запуска процесса).
  - `in_list(["windows", "sysmon"], event_src.title)`: `event_src.title` должно быть "Windows" или "SYSMON".
  - `lower(object) == "process"`: Событие относится к объекту типа "process".
  - `lower(action) == "start"`: Действие (action) должно быть "start".
  - `lower(object.process.name) == "vssvc.exe"`: Имя запущенного процесса должно быть "vssvc.exe".
  - `lower(object.process.parent.name) == "services.exe"`: Имя родительского процесса должно быть "services.exe".

### 2. Событие Process_Stop:

- **key:** Группируется по хосту, на котором произошло событие.

- **filter:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные коррелятором.
  - `in_list(["4689", "5"], msgid)`: `msgid` включает значения "4689" (остановка процесса) и "5" (событие остановки процесса).
  - `in_list(["windows", "sysmon"], event_src.title)`: `event_src.title` должно быть "Windows" или "SYSMON".
  - `lower(object) == "process"`: Событие относится к объекту типа "process".
  - `lower(action) == "stop"`: Действие (action) должно быть "stop".
  - `lower(object.process.name) == "vssvc.exe"`: Имя остановленного процесса должно быть "vssvc.exe".

### 3. Событие ServiceState_Change:

- **key:** Группируется по хосту, на котором произошло событие.

- **filter:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные коррелятором.
  - `msgid == "7036"`: `msgid` должно быть "7036" (событие изменения состояния службы).
  - `event_src.title == "windows"`: `event_src.title` должно быть "Windows".
  - `lower(object) == "application"`: Событие относится к объекту типа "application".
  - `in_list(["Теневое копирование тома", "Volume Shadow Copy"], object.name)`: Имя службы должно быть либо "Теневое копирование тома", либо "Volume Shadow Copy".
