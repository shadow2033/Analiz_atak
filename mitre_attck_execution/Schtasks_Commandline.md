# Правило Schtasks_Commandline

Атакующие используют утилиту `schtasks.exe` или командлеты PowerShell для изменения или создания задач (запланированных заданий) на целевой системе. Эти задачи могут быть настроены для выполнения вредоносных команд или программ в определенное время или при определенных условиях. Это позволяет злоумышленникам закрепить свой доступ к системе, обеспечивая постоянное выполнение вредоносного кода.

## Методы атаки:

1. **Использование `schtasks.exe`:** Атакующие могут использовать утилиту `schtasks.exe`, предоставляемую операционной системой Windows, для создания, изменения или удаления запланированных заданий. Это может быть выполнено из командной строки или сценария.

2. **Использование PowerShell:** Злоумышленники могут также использовать PowerShell для создания, изменения или удаления задач. Это может быть осуществлено с помощью командлетов, таких как `New-ScheduledTaskTrigger` и `Register-ScheduledTask`.

**Цель атаки:** Целью атаки "Schtasks_Commandline" является получение постоянного доступа к целевой системе и выполнение вредоносных команд или программ с использованием запланированных задач. Это может быть использовано для установки и поддержания вредоносных активностей на компьютере, кражи данных, проникновения в сеть и других атак.

## Описание правила

Правило "Schtasks_Commandline" оценивает активность, связанную с запуском задач и использованием утилиты `schtasks.exe`, а также командлетов PowerShell, связанных с управлением запланированными задачами.

### Событие Run_Schtasks_in_Cmd:

Это событие оценивает запуск команд с использованием утилиты `schtasks.exe` из командной строки (`cmd.exe`).

- **key:** Ключ события формируется на основе хоста.
- **filter:** Фильтры:
  - `filter::NotFromCorrelator()`: Исключает события, созданные коррелятором.
  - `filter::ProcessStart_Windows_any()`: Фильтр, который применяется к событиям запуска процессов на системах Windows.
  - `match(lower(object.process.name), "schtasks.exe") or match(lower(object.process.original_name), "schtasks.exe")`: Проверяет, что имя запущенного процесса или его оригинальное имя содержит "schtasks.exe".
  - `regex(lower(object.process.cmdline), "(/|-)(create|change|run|delete|end)\s+", 0) != null`: Проверяет, что командная строка процесса содержит ключевые слова, связанные с управлением заданиями (create, change, run, delete, end).

### Событие Run_Schtasks_in_Powershell_Pipeline:

Это событие оценивает выполнение команд, связанных с управлением запланированными задачами, в PowerShell.

- **key:** Ключ события формируется на основе хоста.
- **filter:** Фильтры:
  - `filter::NotFromCorrelator()`: Исключает события, созданные коррелятором.
  - `msgid == "4103"`: Идентификатор сообщения, указывающий на выполнение команды в PowerShell.
  - `action == "execute" и object == "command"`: Уточнения, связанные с выполнением команды.
  - `event_src.title == "windows"`: Уточнение, что событие связано с операционной системой Windows.
  - `regex(lower(object.process.cmdline), "\b((register|new|set|start|stop|unregister)-scheduledtask(principal)?|registertaskdefinition)\s+", 0) != null`: Проверяет, что командная строка содержит ключевые слова, связанные с управлением заданиями в PowerShell.

### Событие Run_Schtasks_in_Powershell_Command:

Это событие оценивает выполнение команд, связанных с управлением запланированными задачами, в PowerShell.

- **key:** Ключ события формируется на основе хоста и идентификатора объекта (object.id).
- **filter:** Фильтры:
  - `filter::NotFromCorrelator()`: Исключает события, созданные коррелятором.
  - `msgid == "4104"`: Идентификатор сообщения, указывающий на выполнение команды в PowerShell.
  - `action == "execute" и object == "command"`: Уточнения, связанные с выполнением команды.
  - `event_src.title == "windows"`: Уточнение, что событие связано с операционной системой Windows.
  - `regex(lower(object.process.cmdline), "schtasks.*?(/|-)(create|change|run|delete|end)\s+|\b((register|new|set|start|stop|unregister)-scheduledtask(principal)?|registertaskdefinition)\s+", 0) != null`: Проверяет, что командная строка содержит ключевые слова, связанные с управлением заданиями, как в PowerShell, так и в `schtasks.exe`.
