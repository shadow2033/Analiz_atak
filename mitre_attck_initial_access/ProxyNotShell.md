# Правило ProxyNotShell

Атака ProxyNotShell - это кибератака, которая эксплуатирует уязвимости в Microsoft Exchange Server. Эта атака включает в себя использование двух конкретных уязвимостей, а именно CVE-2022-41040 и CVE-2022-41082, для достижения своих целей.

## Методы атаки:

1. **CVE-2022-41040 (CVSS: 8,8) — уязвимость SSRF (подделка запросов на стороне сервера):** Эта уязвимость позволяет злоумышленнику, прошедшему аутентификацию, отправлять поддельные запросы на сервере, будто они отправлены жертвой. Злоумышленники используют GET-запросы с контролируемым URI и данными для выполнения случайных запросов к серверным службам с привилегией LocalSystem. Злоумышленники могут использовать эту уязвимость, чтобы определить, является ли сервер Exchange уязвимым.

2. **CVE-2022-41082 (CVSS: 8,8) — удаленное выполнение кода (RCE):** Эта уязвимость связана с серверной частью Exchange PowerShell и позволяет злоумышленникам удаленно выполнять код на сервере Exchange. Для этого злоумышленник должен иметь доступ к Exchange PowerShell. Успешное использование этой уязвимости может привести к полной компрометации сервера Exchange.

**Цель атаки:** Целью атаки ProxyNotShell являются почтовые серверы Microsoft Exchange, версии 2013, 2016 и 2019. Злоумышленники стремятся получить удаленный доступ и управление над этими серверами, что может привести к компрометации почтовой инфраструктуры организации. Уязвимости CVE-2022-41040 и CVE-2022-41082 позволяют злоумышленникам проникнуть в систему, выполнить код и расширить свой контроль над уязвимым сервером.

## Описание правила

Правило "ProxyNotShell" предназначено для выявления событий, связанных с потенциально подозрительной активностью на хосте. Оно состоит из двух событий, и его целью является обнаружение двух важных фаз атаки: попытки аутентификации с использованием NTLMSSP и попытки скачивания части потенциально вредоносной нагрузки.

### Событие NTLM_Authorizing_Compromised_Account:

- **Ключ события:** Формируется на основе хоста, на котором произошло событие (event_src.host).
- **Условия фильтрации:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `event_src.title == "windows"`: Фильтр для событий, связанных с операционной системой Windows.
  - `msgid == "4624"`: Идентификатор сообщения, связанный с событием успешной аутентификации.
  - `not in_list(["127.0.0.1","::1"], src.ip)`: Исключает аутентификации, происходящие с локального хоста (127.0.0.1 или ::1).
  - `logon_type == 3`: Определяет тип аутентификации (3 - удаленная аутентификация).
  - `status == "success"`: Убеждается, что аутентификация завершилась успешно.
  - `lower(logon_service) == "ntlmssp"`: Уточняет, что используется протокол аутентификации NTLMSSP.
  - `lower(logon_auth_method) == "remote"`: Уточняет, что аутентификация происходит удаленно.

### Событие Download_Part_of_the_Payload:

- **Ключ события:** Формируется на основе хоста, на котором произошло событие (event_src.host).
- **Условия фильтрации:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `filter::ProcessStart_Windows_any()`: Фильтр для событий запуска процессов на системах Windows.
  - `lower(object.process.parent.name) == "w3wp.exe"`: Уточняет, что родительским процессом должен быть "w3wp.exe" (веб-сервер Internet Information Services - IIS).
  - `lower(object.process.name) == "cmd.exe"`: Уточняет, что запущенный процесс должен быть "cmd.exe" (командная оболочка Windows).
  - `regex(lower(object.process.cmdline), "/c echo \S+>>%{1,2}temp%{1,2}\S+.b64", 0) != null`: Проверяет, что командная строка запуска cmd.exe соответствует шаблону "/c echo ... >>%TEMP%\.... b64", что может указывать на скачивание части полезной нагрузки в закодированном виде во временный каталог (%TEMP%).
