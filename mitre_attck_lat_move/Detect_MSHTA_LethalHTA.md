# Правило Detect_MSHTA_LethalHTA

Атака представляет собой новую технику бокового перемещения, использующую DCOM (Distributed Component Object Model) и HTA (HTML Application). Она позволяет злоумышленникам выполнять код и создавать сетевые соединения на целевой системе, обходя средства контроля и безопасности. HTA - это формат файлов Microsoft HTML Applications, а mshta.exe - это утилита, которая выполняет такие файлы. Атака заключается в использовании mshta.exe для выполнения вредоносных файлов .hta, а также для запуска JavaScript или VBScript через доверенную утилиту Windows.

## Методы атаки:

1. **Использование DCOM:** Атака использует DCOM для выполнения кода на удаленной системе. DCOM - это механизм, который позволяет объектам на разных компьютерах взаимодействовать друг с другом через сеть.

2. **Запуск через mshta.exe:** Злоумышленники могут использовать утилиту mshta.exe для выполнения кода из удаленных HTA-файлов, что позволяет им удаленно выполнять вредоносные действия на целевой системе.

3. **Сетевые соединения:** Через эту атаку, злоумышленники могут создавать сетевые соединения на целевой системе, что может быть использовано для передачи данных, команд и контроля над системой.

**Цель атаки:** Целью атаки является выполнение вредоносного кода на удаленной системе и установление контроля над ней. Атака может быть использована для бокового движения внутри сети, обходя средства обнаружения и контроля, а также для установки на системе вредоносных программ, собирания информации или выполнения других вредоносных действий.

## Описание правила

Правило "Detect_MSHTA_LethalHTA" помогает мониторить активность mshta.exe и его потенциальное использование для выполнения злонамеренных действий на системе или установления сетевых соединений с удаленными серверами.

### Событие Spawn_Process_mshta:

- **key:**
  - event_src.host: Хост, на котором произошло событие.
  - object.id: Идентификатор (PID) процесса.
  - subject.account.name: Имя учетной записи, связанной с процессом.
- **filter:**
  - filter::NotFromCorrelator(): События, созданные из коррелятора, исключаются из анализа.
  - event_src.title == "sysmon": Анализируются только события с заголовком "sysmon".
  - msgid == "1": Рассматриваются события с идентификатором "1" (запуск процесса).
  - object.process.name == "mshta.exe": Рассматриваются только процессы с именем "mshta.exe".
  - find_substr(lower(object.process.meta), "html") != null: Проверяется, содержит ли метаданные процесса "html" (возможно, процесс связан с обработкой HTML-файлов).
  - (find_substr(lower(object.process.cmdline), "mshta.exe") != null или find_substr(lower(object.process.cmdline), "-embedding") != null): Проверяется, содержит ли командная строка процесса "mshta.exe" или "-embedding" (что может указывать на запуск HTA-файла).
  - object.process.parent.name == "svchost.exe": Рассматриваются только процессы, у которых родительский процесс имеет имя "svchost.exe".
  - (find_substr(lower(object.process.parent.cmdline), "svchost.exe") != null или find_substr(lower(object.process.parent.cmdline), "dcomlaunch") != null): Проверяется, содержит ли командная строка родительского процесса "svchost.exe" или "dcomlaunch" (что может указывать на использование DCOM для запуска процесса).

### Событие Open_connection:

- **key:**
  - event_src.host: Хост, на котором произошло событие.
  - object.id: Идентификатор (PID) процесса.
  - object.account.name: Имя учетной записи, связанной с процессом.
- **filter:**
  - event_src.title == "sysmon": Анализируются только события с заголовком "sysmon".
  - msgid == "3": Рассматриваются события с идентификатором "3" (открытие сетевого соединения).
  - object.process.name == "mshta.exe": Рассматриваются только процессы с именем "mshta.exe".
  - src.ip != dst.ip: Анализируются события, где IP-адрес источника (src.ip) не совпадает с IP-адресом назначения (dst.ip).
  - protocol == "tcp": Рассматриваются только события с использованием протокола TCP.
  - not in_list(["127.0.0.1", "0:0:0:0:0:0:0:1"], dst.ip): Исключаются события, где IP-адрес назначения (dst.ip) соответствует локальным адресам.
