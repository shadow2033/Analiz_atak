# Правило Impacket_WMIExec_Command_Executed

Атака Impacket_WMIExec_Command_Executed представляет собой угрозу для безопасности систем Windows и использует инструментарий Impacket для выполнения команд через службу Windows Management Instrumentation (WMI).

**WMI (Windows Management Instrumentation)** - это инфраструктура управления и мониторинга в операционных системах Windows. Она предоставляет множество возможностей для удаленного управления и мониторинга системы, включая выполнение команд на удаленных компьютерах.

**Impacket** - это набор инструментов и библиотек Python, который позволяет работать с различными сетевыми протоколами, такими как SMB, MSRPC, Kerberos и другими. Этот инструментарий может использоваться как для легальных целей, такие как аудит и тестирование безопасности, так и для злонамеренных атак.

## Методы атаки

1. **Использование Impacket:** Злоумышленники воспользуются инструментарием Impacket, который обеспечивает функциональность для взаимодействия с различными сетевыми протоколами, такими как SMB и MSRPC. Для атак на службу WMI, атакующие могут использовать соответствующие средства, предоставляемые Impacket.

2. **Запросы к WMI:** Злоумышленники создают запросы к службе WMI, которые могут включать в себя команды, предназначенные для выполнения на удаленной системе. Они могут использовать имеющиеся учетные данные или механизм аутентификации для установления соединения с удаленной системой.

3. **Выполнение команд:** Злоумышленники отправляют команды на целевую систему через службу WMI. Эти команды могут включать в себя выполнение вредоносных скриптов, установку программ или выполнение других действий на целевой системе.

## Цель атаки

Целью атаки Impacket_WMIExec_Command_Executed является выполнение команд на удаленных системах, используя службу WMI. Атакующий может использовать это для:

- Получения удаленного доступа к системам без необходимости интерактивной аутентификации.
- Выполнения команд и скриптов на целевой системе, что может использоваться для эксплуатации уязвимостей или получения информации.
- Распространения злонамеренных программ и атак на другие компьютеры в сети.

## Описание правила

Правило "Impacket_WMIExec_Command_Executed" предназначено для обнаружения потенциально вредоносной активности, связанной с использованием службы WMI для выполнения команд на удаленных системах.

### Событие WmiExec

- **key:**
    - `event_src.host`: Этот ключ формируется на основе хоста, на котором произошло событие.

- **filter:**
    - `filter::NotFromCorrelator()`: Этот фильтр исключает события, которые были созданы коррелятором.
    - `filter::ProcessStart_Windows_any()`: Этот фильтр применяется к событиям запуска процессов на системах Windows, и он ограничивает анализ только для таких событий.
    - `and in_list(["c:\windows\system32\wmiprvse.exe", "c:\windows\system32\wbem\wmiprvse.exe", "c:\windows\syswow64\wbem\wmiprvse.exe"], lower(object.process.parent.fullpath))`: Фильтр проверяет, что родительский процесс, из которого была запущена команда через WMI, соответствует одному из указанных путей к исполняемым файлам **wmiprvse.exe**. Это позволяет выделить только те случаи, когда команда запущена из WMI.

- **Условия срабатывания:**
    - `regex(lower(object.process.cmdline), "cmd.exe\s+/q\s+/c\s+.+\s1>\s+\127.0.0.1\admin\$[\d.]+\s+2>&1", 0) != null`: Это условие проверяет, что команда была выполнена с использованием cmd.exe с определенными параметрами. Кроме того, оно проверяет, что вывод команды был перенаправлен в \127.0.0.1\admin\$[\d.]+. Это может указывать на попытку использования WMI для выполнения скрытых команд.

        Это правило позволяет обнаружить попытки использования Impacket и службы WMI для выполнения команд на удаленных системах.
