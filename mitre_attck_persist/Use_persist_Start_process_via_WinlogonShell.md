# Правило Use_persist_Start_process_via_WinlogonShell

Атакующие могут использовать функции Winlogon для выполнения DLL-файлов и/или исполняемых файлов при входе пользователя в систему. Winlogon.exe является компонентом Windows, отвечающим за действия при входе/выходе из системы, а также за выполнение безопасной последовательности внимания (SAS). Записи в реестре в `HKLM\Software[\Wow6432Node\]\Microsoft\Windows NT\CurrentVersion\Winlogon` и `HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon` используются для управления дополнительными вспомогательными программами и функциональностью, поддерживающей Winlogon.

## Методы атаки:

1. Атакующие могут модифицировать записи в реестре, связанные с Winlogon, чтобы заставить Winlogon загружать и выполнять зловредные DLL-файлы и/или исполняемые файлы.
2. Конкретно, следующие подразделы могут быть уязвимыми для злоупотребления:
   - Winlogon\Notify: указывает на DLL-файлы пакета уведомлений, которые обрабатывают события Winlogon.
   - Winlogon\Userinit: указывает на userinit.exe, программу инициализации пользователя, которая выполняется при входе пользователя.
   - Winlogon\Shell: указывает на explorer.exe, оболочку системы, которая выполняется при входе пользователя.

**Цель атаки:**  Целью атаки может быть получение постоянного доступа к системе с целью дальнейшего выполнения вредоносных действий, кражи данных или других злоупотреблений.

## Описание правила

Правило "Use_persist_Start_process_via_WinlogonShell" обнаруживает события запуска процессов, которые выполняются в контексте сессии пользователя и имеют userinit.exe как родительский процесс, но не являются процессом explorer.exe. Такие события могут указывать на необычную активность, связанную с запуском процессов в рамках пользовательской сессии и могут быть потенциально подозрительными.

### Событие "event DSRM_Password_Set"

- **key:** Ключ формируется на основе следующих параметров:
  - `event_src.host` - хост, на котором произошло событие.
  - `object.account.session_id` - идентификатор сессии учетной записи, связанной с событием.
- **filter:**
  - `filter::NotFromCorrelator()` - исключает события, созданные из коррелятора.
  - `in_list(["1","4688"], msgid)` - фильтр, который пропускает только события с идентификаторами 1 или 4688 (события запуска процессов).
  - `lower(object) == "process"` - фильтр, который проверяет, что объект события имеет значение "process" (процесс).
  - `lower(action) == "start"` - фильтр, который проверяет, что действие события - это запуск процесса.
  - `lower(object.process.parent.name) == "userinit.exe"` - фильтр, который проверяет, что родительский процесс имеет имя "userinit.exe" (часто используется при входе пользователя в систему).
  - `lower(object.process.name) != "explorer.exe"` - фильтр, который исключает события, где имя запущенного процесса равно "explorer.exe".
