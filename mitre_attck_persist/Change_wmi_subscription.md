#  Правило Change_wmi_subscription

Атака "Change_wmi_subscription" использует функциональные возможности Windows Management Instrumentation (WMI) для подписки на события и выполнения произвольного кода при возникновении этих событий. Это обеспечивает устойчивость (постоянство) на системе и может быть использовано для различных целей, таких как боковое (горизонтальное) перемещение, установление контроля над системой, выполнение кода.

## Методы атаки:

1. **Использование WMI:** Злоумышленники могут использовать WMI для создания подписок на события, которые происходят на целевой системе. Эти события могут включать в себя события, связанные с запуском новых процессов, неудачными попытками входа в систему и другими. Злоумышленники создают три класса: __EventFilter, EventConsumer и __FilterToConsumerBinding, которые используются для хранения кода, описания событий и их связей. При возникновении события, указанного в подписке, выполняется произвольный код.

2. **Постоянство:** Атака позволяет злоумышленникам обеспечить постоянство на целевой системе. Подписка на событие остается активной и после перезагрузки системы, а ее выполнение выполняется от имени системного пользователя (SYSTEM), что дает злоумышленникам высокие привилегии.

3. **Инструменты и скрипты:** Для выполнения этой атаки можно использовать инструменты и фреймворки, такие как Metasploit, Empire, PoshC2, PowerSploit, а также PowerShell скрипты и инструменты на C#. Эти инструменты автоматизируют процесс создания подписок на события и выполнения кода при их возникновении.

**Цель атаки:** Целью атаки "Change_wmi_subscription" является обеспечение постоянства на системе и, при необходимости, повышение привилегий злоумышленников. Злоумышленники могут использовать эту атаку для выполнения произвольного кода на целевой системе при определенных событиях, что позволяет им оставаться незамеченными и управлять системой.

## Описание правила

Правило "Change_wmi_subscription" описывает события, связанные с созданием объектов в рамках Windows Management Instrumentation (WMI), которые наблюдаются с помощью инструмента Sysmon.

### Событие "WmiEventConsumerToWmiEventFilter_19":

- **key:** Основной ключ формируется на основе хоста, на котором произошло событие.

- **filter:** Фильтр события описывает следующие условия:
  - `msgid == "19"`: Это идентификатор сообщения, связанного с этим событием, равен 19.
  - `event_src.title == "sysmon"`: Событие было сгенерировано инструментом Sysmon.
  - `object.state == "created"`: Событие связано с созданием объекта (в данном случае, видимо, объектов WMI).

### Событие "WmiEventConsumer_20":

- **key:** Ключ формируется так же, как и в предыдущем правиле, на основе хоста, на котором произошло событие.

- **filter:** Фильтр события определяет следующие условия:
  - `msgid == "20"`: Идентификатор сообщения равен 20.
  - `event_src.title == "sysmon"`: Событие сгенерировано инструментом Sysmon.
  - `object.state == "created"`: Событие связано с созданием объекта.

### Событие "WmiEventConsumerToFilter_21":

- **key:** Опять же, ключ формируется на основе хоста, на котором произошло событие.

- **filter:** Фильтр события определяет следующие условия:
  - `msgid == "21"`: Идентификатор сообщения равен 21.
  - `event_src.title == "sysmon"`: Событие сгенерировано инструментом Sysmon.
  - `object.state == "created"`: Событие связано с созданием объекта.
