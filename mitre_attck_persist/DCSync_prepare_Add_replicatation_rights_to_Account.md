# Правило DCSync_prepare_Add_replicatation_rights_to_Account

**DCSync** - это метод атаки, используемый злоумышленниками для извлечения учетных данных из контроллеров домена в среде Active Directory. Для этого атакующий имитирует контроллер домена и использует протокол MS-DRSR (Microsoft Directory Replication Service Remote) для выполнения запросов на репликацию данных с контроллера домена. Одним из запросов является GetNCChanges (получение изменений в наборе контрольных точек). Контроллер домена отвечает на такой запрос, возвращая данные репликации, включая хэши паролей учетных записей. Это позволяет злоумышленникам получить доступ к хранимым в Active Directory учетным данным.

## Методы атаки:

1. **Добавление прав доступа:** Перед проведением атаки DCSync злоумышленники могут предпринимать меры по добавлению необходимых прав доступа к аккаунтам в Active Directory. Эти права включают:
    - Репликация изменений каталога (DS-Replication-Get-Changes)
    - Репликация каталога Changes All (DS-Replication-Get-Changes-All)
    - Репликация изменений каталога в отфильтрованном наборе (DS-Replication-Get-Changes-In-Filtered-Set) (необязательно, но может быть добавлено)

2. **Применение прав доступа:** После добавления необходимых прав доступа, злоумышленники могут запускать DCSync-атаку, которая позволяет получить данные репликации, включая хэши паролей, из контроллера домена.

**Цель атаки:**  Целью атаки DCSync является получение хэшей паролей учетных записей из Active Directory. Эти хэши могут быть использованы злоумышленниками для дальнейшей аутентификации и получения доступа к системам и данным в сети. Обычно злоумышленники ориентируются на аккаунты с повышенными привилегиями, такими как администраторы домена или администраторы предприятия, чтобы расширить свой доступ в среде Active Directory и выполнить дополнительные атаки.

## Описание правила

Правило "DCSync_prepare_Add_replicatation_rights_to_Account" анализирует события в Active Directory, связанные с модификацией объектов. Они фокусируются на изменениях, связанных с объектами определенного типа, свойством "nTSecurityDescriptor" и определенными подстроками в значении объекта. Они направлены на обнаружение определенных изменений в политиках безопасности или нарушений прав доступа к ресурсам Active Directory, что может указывать на потенциальные угрозы или несанкционированные изменения.

### Событие "event ADobject_DeleteValue"

**key:** Ключ формируется на основе следующих параметров:
- `event_src.host` - хост, на котором произошло событие.
- `msgid` - идентификатор сообщения (msgid).
- `object.type` - тип объекта.
- `object.id` - идентификатор объекта.

**filter:**
- `filter::NotFromCorrelator()`: Это условие исключает события, созданные из коррелятора.
- `msgid == "5136"`: Это условие проверяет, что идентификатор сообщения (msgid) равен "5136". В Windows Event Log, "5136" обозначает событие, связанное с изменением объекта в Active Directory.
- `object == "ds_object"`: Это условие определяет, что объект, над которым проводится действие, должен быть объектом директории (ds_object), что указывает на объекты в Active Directory.
- `action == "modify"`: Условие проверяет, что действие, совершенное над объектом, является действием модификации (modify), что означает изменение объекта.
- `in_list(["domainDNS", "19195a5b-6da0-11d0-afd3-00c04fd930c9"], object.type) == True`: Это условие проверяет, что тип объекта (object.type) либо равен "domainDNS", либо равен "19195a5b-6da0-11d0-afd3-00c04fd930c9". Это фильтрует события только для указанных типов объектов в Active Directory.
- `object.state == "value deleted"`: Это условие проверяет, что состояние объекта (object.state) является "value deleted", что указывает на удаление значения свойства объекта.
- `object.property == "nTSecurityDescriptor"`: Условие проверяет, что свойство объекта (object.property) является "nTSecurityDescriptor", что указывает на изменение в объекте, связанное с его безопасностью.

### Событие "event ADobject_AddValue"

**key:** Ключ формируется на основе следующих параметров:
- `event_src.host` - хост, на котором произошло событие.
- `msgid` - идентификатор сообщения (msgid).
- `object.type` - тип объекта.
- `object.id` - идентификатор объекта.

**filter:**
- `filter::NotFromCorrelator()`: Это условие исключает события, созданные из коррелятора.
- `msgid == "5136"`: Это условие проверяет, что идентификатор сообщения (msgid) равен "5136".
- `object == "ds_object"`: Условие определяет, что объект, над которым проводится действие, должен быть объектом директории (ds_object).
- `action == "modify"`: Условие проверяет, что действие, совершенное над объектом, является действием модификации (modify).
- `in_list(["domainDNS", "19195a5b-6da0-11d0-afd3-00c04fd930c9"], object.type) == True`: Это условие проверяет, что тип объекта (object.type) либо равен "domainDNS", либо равен "19195a5b-6da0-11d0-afd3-00c04fd930c9".
- `object.state == "value added"`: Это условие проверяет, что состояние объекта (object.state) является "value added", что указывает на добавление значения свойства объекта.
- `object.property == "nTSecurityDescriptor"`: Это условие проверяет, что свойство объекта (object.property) равно "nTSecurityDescriptor". В контексте систем Active Directory это свойство отвечает за хранение информации о безопасности объекта.
- `(find_substr(object.value, "1131f6ad-9c07-11d1-f79f-00c04fc2dcd2") != null or find_substr(object.value, "1131f6aa-9c07-11d1-f79f-00c04fc2dcd2") != null or find_substr(object.value, "89e95b76-444d-4c62-991a-0facbeda640c") != null)`: Это условие выполняется, если хотя бы одна из следующих подстрок присутствует в значении свойства объекта (object.value):
  - "1131f6ad-9c07-11d1-f79f-00c04fc2dcd2"
  - "1131f6aa-9c07-11d1-f79f-00c04fc2dcd2"
  - "89e95b76-444d-4c62-991a-0facbeda640c"

Эти подстроки, вероятно, являются идентификаторами или маркерами, связанными с определенными аспектами безопасности или разрешениями объекта.
