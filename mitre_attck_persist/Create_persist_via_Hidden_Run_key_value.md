# Правило Create Persist via Hidden Run Key Value

Атакующие могут использовать различные методы для достижения устойчивости на зараженной системе, добавляя программу в автозапуск через скрытые значения ключей реестра. Это позволяет им обеспечить выполнение зловредного кода при каждом входе пользователя в систему. Уровень разрешений для запускающихся программ будет соответствовать уровню разрешений учетной записи пользователя.

## Методы атаки:

1. **Добавление записи в ключи "Run" и "RunOnce" реестра:** Злоумышленники могут добавить запись в ключи реестра Windows, такие как "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" или "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run". При этом указанная программа будет выполняться при входе пользователя в систему. Запись в "RunOnce" будет выполнена только один раз при следующем входе.

2. **Помещение программы в папку автозапуска:** Злоумышленники могут разместить исполняемый файл программы в специальные папки автозапуска, такие как папка автозапуска текущего пользователя "C:\Users[Username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup" или папка автозапуска для всех пользователей "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp". После этого программа будет запускаться при каждом входе в систему, как для текущего пользователя, так и для всех пользователей.

3. **Использование других ключей и методов реестра:** Злоумышленники могут также использовать другие ключи реестра, такие как "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run" и "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run", чтобы добавить программу в автозапуск через политики групповой политики Windows.

4. **Использование ключей реестра для автозапуска служб:** Злоумышленники могут создавать записи в ключах реестра, таких как "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices" и "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices", чтобы автоматически запускать службы при загрузке системы.

## Цель атаки:

- **Достижение устойчивости на системе:** Атакующие стремятся обеспечить выполнение своего зловредного кода на целевой системе при каждом входе пользователя, чтобы долгосрочно контролировать и манипулировать системой.

- **Сокрытие от обнаружения:** Использование скрытых автозапусков и маскировка под легитимные записи реестра помогает избежать обнаружения и анализа антивирусными и безопасностными системами.

## Описание правила

Правило "Create_persist_via_Hidden_Run_key_value" служит для мониторинга действий, связанных с реестром Windows. Правило определяет события, которые могут указывать на потенциально опасные действия в реестре системы.

- **Key:** Оно указывает хост (компьютер), на котором произошло событие.

### Фильтр:

- `filter::NotFromCorrelator()`: Этот фильтр исключает события, созданные из коррелятора.

Фильтр состоит из двух основных частей, объединенных оператором `or`. Эти части фильтра рассматривают разные источники событий и типы изменений в реестре:

#### Первая часть:

- `event_src.title == "sysmon"`: Этот фрагмент проверяет, что источник события является Sysmon.
- `msgid == "13"`: Этот фрагмент проверяет, что идентификатор сообщения равен "13", что, вероятно, указывает на событие модификации реестра.
- `lower(object) == "reg_object"`: Этот фрагмент проверяет, что объект события имеет тип "reg_object".
- `lower(action) == "modify"`: Этот фрагмент проверяет, что действие над объектом - это "modify" (изменение).
- `match(object.fullpath, "currentversion\run") == True`: Этот фрагмент использует функцию сопоставления для проверки, содержит ли путь объекта фразу "currentversion\run". Это может указывать на изменение ключа реестра, связанного с автозапуском приложений.
- `object.name == null`: Этот фрагмент проверяет, что имя объекта отсутствует. Вероятно, это используется для фильтрации изменений в реестре, не связанных с конкретными записями.

#### Вторая часть:

- `event_src.title == "windows"`: Этот фрагмент проверяет, что источник события - Windows.
- `msgid == "4657"`: Этот фрагмент проверяет, что идентификатор сообщения равен "4657", что может указывать на событие изменения прав доступа к объекту в реестре.
- `lower(object) == "reg_object"`: Этот фрагмент проверяет, что объект события имеет тип "reg_object".
- `lower(object.new_value) == "%%1904"`: Этот фрагмент проверяет, что новое значение объекта в реестре равно "%%1904". Это может быть связано с изменением ключа реестра.
- `match(object.fullpath, "currentversion\run") == True`: Так же, как и в первой части, этот фрагмент проверяет путь объекта на наличие фразы "currentversion\run".
- `object.name == null`: Этот фрагмент также проверяет отсутствие имени объекта.
