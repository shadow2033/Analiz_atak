# Правило Create_persist_via_WinlogonShell

Атакующие могут использовать функциональные возможности Winlogon в операционной системе Windows для выполнения вредоносных библиотек DLL и/или исполняемых файлов при входе пользователя в систему. Winlogon.exe является компонентом Windows, ответственным за управление процессом входа и выхода пользователя, а также за последовательность безопасного внимания (SAS), которая запускается при нажатии комбинации клавиш Ctrl-Alt-Delete. Реестровые записи используются для управления дополнительными вспомогательными программами и функциями, поддерживающими Winlogon.

Вредоносные изменения в разделах реестра, связанных с Winlogon, могут привести к тому, что Winlogon будет загружать и выполнять вредоносные библиотеки DLL и/или исполняемые файлы. Особенно уязвимыми могут быть следующие подразделы:

- **Winlogon\Shell**: указывает на explorer.exe, оболочку системы, которая выполняется при входе пользователя в систему.

## Методы атаки

Атакующие могут использовать различные методы для осуществления атаки "Create_persist_via_WinlogonShell":

1. **Изменение реестра**: Злоумышленники могут изменить соответствующие записи реестра, такие как Winlogon\Shell, чтобы указать на вредоносные исполняемые файлы или библиотеки DLL вместо стандартной системной оболочки.

2. **Применение подписанных файлов**: Атакующие могут подделать цифровую подпись вредоносных файлов, чтобы обойти механизмы проверки подписи в Windows и обеспечить выполнение своего кода.

## Цель атаки

- Установить постоянное присутствие (постоянное внедрение) на зараженной системе, чтобы обеспечить выполнение вредоносного кода при каждом входе пользователя в систему.

- Обойти механизмы безопасности операционной системы, предназначенные для обнаружения и предотвращения атак.

- Получить контроль над системой пользователя и выполнять различные действия, например, сбор данных или выполнение других вредоносных операций.

## Описание правила

Это правило срабатывает на событие модификации реестра (RegistryModification) и имеет следующую конфигурацию:

- **key:** Ключ формируется на основе хоста, на котором произошло событие.

- **filter:**

  - `filter::NotFromCorrelator()`: Исключает события, которые были созданы коррелятором.

  - `in_list(["13", "4657"], msgid)`: Включает в события с msgid, равными "13" (соответствующим событиям Sysmon) и "4657" (соответствующим событиям Windows). Это означает, что правило будет применяться к событиям модификации реестра, связанным как с Sysmon, так и с Windows Event Log.

  - `lower(object) == "reg_object"`: Фильтрует события, где объект (object) имеет значение "reg_object". Это указывает на то, что изменения в реестре отслеживаются только в отношении реестровых объектов.

  - `find_substr(lower(object.fullpath), "currentversion\winlogon") != null`: Используется для поиска событий, связанных с изменениями в разделе реестра "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Winlogon". То есть, события, где происходят модификации в этом разделе.

  - `lower(object.name) == "shell"`: Фильтрует события, связанные с изменением значения реестрового ключа "Shell". "Shell" обычно указывает на системную оболочку, которая будет запущена при входе пользователя.

  - `find_substr(lower(object.new_value), ",") != null`: Фильтрует события, где новое значение (new_value) содержит запятую. Это может указывать на попытку изменения значения "Shell" на что-то более сложное или дополнительное.
