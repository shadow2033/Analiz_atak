# Правило Use_persist_Start_process_via_WinlogonShell

Атакующие могут воспользоваться опцией "xp_cmdshell" в Microsoft SQL Server для выполнения операционных команд на целевом сервере. Опция "xp_cmdshell" позволяет выполнять команды операционной системы через SQL-запросы, что может быть использовано злоумышленниками для установки персистентного доступа к системам.

## Методы атаки:

**Включение опции "xp_cmdshell":** Атакующие могут включить опцию "xp_cmdshell" после активации опции "show advanced options" в Microsoft SQL Server. Это делает возможным выполнение операционных команд через SQL-запросы, что может быть использовано для выполнения вредоносных действий на сервере.

## Цель атаки:

- **Получение контроля над системой:** Целью атаки является получение возможности выполнения команд на уровне операционной системы. Это может привести к полному контролю над системой, на которой работает MSSQL, и возможности выполнения различных действий, таких как создание, изменение или удаление файлов, выполнение вредоносных скриптов и многое другое.

- **Установка постоянного доступа:** Путем включения "xp_cmdshell" злоумышленники могут обеспечить себе постоянный доступ к системе, что может быть использовано для долгосрочных атак и эксплуатации уязвимостей.

## Описание правила

Правило "Use_persist_Start_process_via_WinlogonShell" используется для мониторинга и обнаружения активации опции "xp_cmdshell" и "show advanced options" в SQL Server, что может указывать на потенциальные угрозы безопасности.

### Событие "event XP_Cmdshell_Enable"

- **key:** Ключ формируется на основе следующих параметров:
  - `event_src.host` - хост, на котором произошло событие.

- **filter:**
  - `filter::NotFromCorrelator()` - исключает события, созданные из коррелятора.
  - `event_src.title == "sql_server"` - Фильтрует события, связанные только с SQL Server.
  - `msgid == "15457"` - Ожидает события с определенным идентификатором сообщения.
  - `reason == "parameter enabled"` - Фильтрует события, связанные с активацией параметров.
  - `lower(object.value) == "xp_cmdshell"` - Проверяет, что значение параметра, активированного в SQL Server, именно "xp_cmdshell".

### Событие "event Advanced_Options_Enable"

- **key:** Ключ формируется на основе следующих параметров:
  - `event_src.host` - хост, на котором произошло событие.

- **filter:**
  - `filter::NotFromCorrelator()` - исключает события, созданные из коррелятора.
  - `event_src.title == "sql_server"` - Фильтрует события, связанные только с SQL Server.
  - `msgid == "15457"` - Ожидает события с определенным идентификатором сообщения.
  - `reason == "parameter enabled"` - Фильтрует события, связанные с активацией параметров.
  - `lower(object.value) == "show advanced options"` - Проверяет, что значение параметра, активированного в SQL Server, именно "show advanced options".
