# Правило IIS_RDP_or_SMB_Tunneling

## Описание атаки
Атака с использованием инструмента Tunna представляет собой метод обхода ограничений сети в полностью защищенных средах. Tunna представляет собой набор инструментов, способных обернуть и туннелировать любое TCP-соединение через протокол HTTP.

**Цель атаки:** Целью атаки с использованием Tunna является обход сетевых ограничений и фильтров, налагаемых на сетевой трафик.


**Принцип работы:** Атака Tunna основана на идее обертывания и туннелирования TCP-соединений через протокол HTTP. Это достигается следующим образом:

1. **Установление соединения:** Злоумышленник создает TCP-соединение с удаленным сервером, который должен быть достигнут, но который может быть недоступен из-за сетевых ограничений.

2. **Запаковка в HTTP:** С помощью инструмента Tunna, злоумышленник упаковывает TCP-пакеты в HTTP-запросы и отправляет их на сервер, который имеет доступ к интернету. Таким образом, сеть, блокирующая прямое TCP-соединение, не обнаруживает ничего подозрительного, так как весь трафик выглядит как обычные HTTP-запросы.

3. **Распаковка на сервере:** На удаленном сервере, имеющем доступ к интернету, HTTP-запросы распаковываются, и данные из них перенаправляются на исходный TCP-сервер, создавая виртуальное TCP-соединение.

4. **Обмен данными:** После установления виртуального TCP-соединения, данные между клиентом и сервером могут обмениваться, не вызывая подозрений в сети.

## Описание правила

Правило "IIS_RDP_or_SMB_Tunneling" является правилом обнаружения потенциально подозрительной активности в сети, связанной с использованием HTTP-трафика для туннелирования протоколов RDP (Remote Desktop Protocol) и SMB (Server Message Block). Давайте разберемся с правилом и его логикой.

**Ключ события:** Это правило применяется к событиям на основе хоста, то есть к хостам, на которых запущен веб-сервер IIS.

### Фильтр
 В этом разделе описаны условия, которые должны выполняться, чтобы событие было рассмотрено как потенциально подозрительное. Они включают:
  - `filter::NotFromCorrelator()`: Исключение событий, которые пришли от собственного коррелятора.
  - `object.process.name == "w3wp.exe"`: Событие должно быть связано с процессом w3wp.exe, что характерно для веб-сервера IIS.
  - `in_list([445, 3389], dst.port)`: Целевой порт должен быть 445 (TCP) или 3389 (RDP).
  - `(event_src.title == "windows" and msgid == "5156") or (event_src.title == "sysmon" and msgid == "3")`: Событие должно иметь заголовок "windows" и идентификатор сообщения (msgid) 5156 или заголовок "sysmon" и msgid 3.
