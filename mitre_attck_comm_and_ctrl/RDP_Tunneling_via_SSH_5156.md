# Правило RDP Tunneling via SSH (5156)

## Описание атаки

Атака "RDP Tunneling via SSH (5156)" представляет собой методику установки соединения с удаленным рабочим столом (RDP) через обратный SSH-туннель с использованием инструментов plink.exe и FreeSSHd. Этот подход позволяет обойти ограничения и защитные меры, установленные на сети и на удаленном сервере.

**Цель атаки:** Целью атаки с использованием Tunna является обход сетевых ограничений и фильтров, налагаемых на сетевой трафик.

## Шаги атаки

1. **Установка FreeSSHd**: На первом этапе злоумышленник устанавливает FreeSSHd, который является SSH-сервером для Windows. Этот сервер позволяет создавать SSH-соединения.

2. **Установка PuTTY**: Затем злоумышленник устанавливает PuTTY, включающий в себя инструмент plink.exe, который будет использоваться для установки SSH-соединения и создания туннеля.

3. **Настройка параметров туннелирования в FreeSSHd**: В FreeSSHd злоумышленник настраивает параметры туннелирования SSH, определяя порт, на котором будет прослушиваться SSH-сервер, и порт RDP-сервера.

4. **Создание учетных записей пользователей в FreeSSHd**: Злоумышленник создает учетные записи пользователей в FreeSSHd, которые будут использоваться для аутентификации при установке SSH-соединения.

5. **Создание пар ключей для каждого пользователя с помощью PuTTYgen**: Для каждой учетной записи пользователей генерируются пары ключей (открытый и закрытый), которые будут использоваться при аутентификации на SSH-сервере.

6. **Тестирование конфигурации FreeSSHd с помощью PuTTY**: Злоумышленник проверяет конфигурацию FreeSSHd, устанавливая SSH-соединение с использованием PuTTY и ключей, сгенерированных ранее.

7. **Добавление реестрового ключа на удаленный сервер**: На этом этапе злоумышленник вносит изменения в реестр удаленного сервера, с целью отключить интерактивное подтверждение ключа SSH при установке SSH-соединения. Это действие позволяет злоумышленнику устанавливать SSH-соединение с удаленным сервером без необходимости ручного подтверждения SSH-ключа сервера.

8. **Загрузка plink.exe на удаленный сервер**: Злоумышленник загружает инструмент plink.exe на удаленный сервер (компрометированный сервер), который будет использоваться для создания SSH-туннеля.

9. **Запуск plink.exe на удаленном сервере**: Злоумышленник запускает plink.exe на удаленном сервере, создавая SSH-туннель к серверу, на котором запущен RDP.

10. **Доступ к туннелированной RDP-сессии через локальный порт с помощью RDP-клиента**: Теперь злоумышленник может подключаться к удаленному серверу через туннель с использованием RDP-клиента, который подключается к локальному порту, на который транслируется удаленный рабочий стол.

## Описание правила

Правило "RDP_Tunneling_via_SSH_5156" отслеживает событие Windows с ID 5156 и анализирует его с целью обнаружения потенциальных попыток использования SSH-туннелирования для доступа к службе RDP.



**Ключ события:**`event_src.host`: Группирует события по хосту, на котором они произошли.

### Фильтр

- `filter::NotFromCorrelator()`: Исключает события, сгенерированные коррелятором.
- `event_src.title == "windows" and msgid == "5156"`: Фильтрация событий, которые имеют `event_src.title` равное "windows" и `msgid` равное "5156".
- `dst.port == 3389 and (in_subnet(src.ip, "127.0.0.0/8") or in_list(["::1"], src.ip))`: Этот фильтр идентифицирует события, в которых порт назначения (`dst.port`) равен 3389 (стандартный порт RDP) и исходный IP-адрес (`src.ip`) принадлежит подсети "127.0.0.0/8" (локальный IP-адрес) или равен "::1" (IPv6-адрес локального хоста).
