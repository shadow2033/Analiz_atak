# Правило Portforward_netsh

Атака "Portforward_netsh" представляет собой способ переадресации портов на компьютере с использованием инструмента `netsh` в операционной системе Windows. Эта атака может быть использована злоумышленниками для установки правил переадресации портов, что позволяет им перехватывать сетевой трафик и перенаправлять его на другие порты или хосты.

## Методы атаки:

1. **Использование утилиты `netsh`:** Злоумышленники могут использовать команду `netsh` в операционной системе Windows для настройки переадресации портов. Эта утилита предоставляет доступ к сетевым настройкам и может быть использована для создания правил переадресации портов.

2. **Создание правил переадресации:** Злоумышленники создают правила в утилите `netsh`, которые указывают на переадресацию сетевого трафика с одного порта на другой. Например, внешний порт на атакующем сервере может быть настроен для перенаправления на внутренний порт на целевой системе.

3. **Обход брандмауэра и фильтров:** Переадресация портов может помочь злоумышленникам обойти сетевые брандмауэры и фильтры трафика, так как трафик может проникать внутрь сети через открытые порты.

4. **Сокрытие следов:** Злоумышленники могут попытаться скрыть свои следы, устанавливая переадресацию таким образом, чтобы атака выглядела как легитимная сетевая активность.

**Цель атаки:** Целью атаки "Portforward_netsh" является переадресация сетевого трафика через уязвимую систему. Эта атака может быть использована злоумышленниками для создания незаметного моста между внешней сетью и внутренней сетью, обходя защитные брандмауэры и фильтры трафика.

## Описание правила

Правило "Portproxy_netsh" предназначено для обнаружения определенных событий в системном журнале Windows и Sysmon, связанных с использованием команды `netsh.exe` для настройки переадресации портов.

### Событие Registry_set_portforward:

- **key:** Хост, на котором произошло событие.
- **filter:** Условия фильтрации:
  - `filter::NotFromCorrelator()`: Исключение событий, созданных из коррелятора.
  - `msgid == "13" and lower(event_src.title) == "sysmon"`: События мониторятся в Sysmon (msgid "13" и title "sysmon").
  - `msgid == "4657" and lower(event_src.title) == "windows"`: События мониторятся в Windows Event Log (msgid "4657" и title "windows").
  - `object == "reg_object"`: Фильтр по объекту.
  - `regex(lower(object.path), "v4|6tov4|6\tcp$", 0) != null`: Проверка пути к (`object.path`) на наличие строк "v4", "6tov4" или "6\tcp$".
  - `object.name != "" и object.new_value != ""`: Фильтры, которые проверяют, что имя объекта и новое значение объекта не пусты.

### Событие Process_netsh:

- **key:** Хост, на котором произошло событие.
- **filter:** Условия фильтрации:
  - `filter::NotFromCorrelator()`: Исключение событий, созданных из коррелятора.
  - `msgid == "1" and event_src.title == "sysmon"`: События мониторятся в Sysmon (msgid "1" и title "sysmon").
  - `msgid == "4688" and event_src.title == "windows"`: События мониторятся в Windows Event Log (msgid "4688" и title "windows").
  - `object == "process"`: Фильтр по объекту, указывающий, что мониторится процесс.
  - `object.process.name == "netsh.exe"`: Проверка, что имя процесса равно "netsh.exe".
  - `regex(lower(object.process.cmdline), "i[ntrface]{0,10}\s+p[ort]{0,4}\s+a[d]{0,3}", 0) != null`: Проверка командной строки процесса на наличие ключевых слов, указывающих на создание правил переадресации портов через "netsh".
