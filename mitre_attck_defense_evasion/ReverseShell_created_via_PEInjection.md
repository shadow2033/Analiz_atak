# Правило ReverseShell_created_via_PEInjection

Атака "ReverseShell_created_via_PEInjection" - это метод, при котором злоумышленники используют техники внедрения кода в процесс, чтобы скрытно выполнить зловредную нагрузку, например, обратную оболочку (Reverse Shell). Для этого могут использоваться два подхода: Reflective Code Loading и Process Injection.

## Методы атаки

### Reflective Code Loading (Загрузка кода с отражением)

Reflective Code Loading позволяет загружать код в память процесса, обеспечивая выполнение кода в контексте этого процесса. Этот метод включает в себя:

- Выделение памяти внутри процесса.
- Выполнение зловредной нагрузки непосредственно в памяти процесса, без создания нового потока или процесса с файловым путем на диске.
- Загружаемая нагрузка может представлять собой скомпилированный бинарный код, анонимные файлы (существующие только в оперативной памяти) или небольшие куски исполняемого кода без файлов.
- Reflective Code Loading может помочь атакующим скрыть выполнение кода, так как его выполнение может быть замаскировано внутри легитимного или безопасного процесса.

### Process Injection (Внедрение в процесс)

Process Injection представляет собой метод выполнения произвольного кода в адресном пространстве другого работающего процесса. Это позволяет атакующим получить доступ к памяти этого процесса, системным/сетевым ресурсам и, возможно, повысить привилегии. Преимущества внедрения в процесс включают:

- Обход обнаружения продуктами безопасности, так как выполнение замаскировано под легитимный процесс.
- Возможность доступа к конфиденциальным данным.
- Возможность долгосрочного присутствия в системе для дальнейших атак.

Существует множество различных способов внедрения кода в процесс, многие из которых злоупотребляют легитимными функциональностями. Некоторые более сложные образцы атаки могут выполнять несколько внедрений кода для дополнительного обхода обнаружения, используя механизмы межпроцессного взаимодействия (IPC) или именованные каналы как канал связи.

**Цель атаки:** Основная цель этой атаки - выполнить зловредный код в системе, скрыть его от обнаружения и, возможно, получить доступ к конфиденциальным данным или обеспечить долгосрочное присутствие в системе для дальнейших атак.

## Описание правила

Правило "ReverseShell_created_via_PEInjection" обеспечивает мониторинг запуска процессов, доступа к процессам и обнаружения сетевых соединений на хосте.

### Событие Process_Start

- **key:** Формируется на основе хоста, на котором произошло событие, и идентификатора (PID) запущенного процесса.
- **filter:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `in_list(["1","4688"], msgid)`: Включает события с msgid равными "1" или "4688".
  - `lower(object) == "process"`: Фильтр по типу объекта, который должен быть процессом.
  - `lower(action) == "start"`: Фильтр по действию, которое должно быть "start" (запуск).

### Событие AccessProccess (Доступ к процессу)

- **key:** Также формируется на основе хоста и идентификатора (PID) процесса.
- **filter:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `msgid == "10"`: Включает события с msgid, равными "10".
  - `lower(object) == "process"`: Фильтр по типу объекта, который должен быть процессом.
  - `lower(action) == "access"`: Фильтр по действию, которое должно быть "access" (доступ).
  - `in_list(["0x1fffff", "0x0028", "0x043A"], object.value) != null`: Фильтр, который включает события, если значение object.value входит в заданный список числовых значений (0x1fffff, 0x0028, 0x043A).

### Событие Network_Connect (Сетевое подключение)

- **key:** Опять же, формируется на основе хоста и идентификатора (PID) процесса.
- **filter:**
  - `filter::NotFromCorrelator()`: Исключает события, созданные из коррелятора.
  - `in_list(["5156","3"], msgid)`: Включает события с msgid, равными "5156" или "3".
  - `lower(object) == "connection"`: Фильтр по типу объекта, который должен быть соединением.
  - `lower(action) == "detect"`: Фильтр по действию, которое должно быть "detect" (обнаружение).
