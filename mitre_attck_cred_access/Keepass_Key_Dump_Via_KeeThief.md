# Правило Keepass_Key_Dump_Via_KeeThief

**KeeThief** - это атака, направленная на извлечение ключевых материалов (паролей и других секретных данных) из менеджера паролей KeePass версии 2.X, который работает в оперативной памяти.

## Методы атаки

1. **GetKeePassMasterKeys():** Этот метод KeeTheft присоединяется к запущенному процессу KeePass с помощью библиотеки CLR MD (Common Language Runtime Metadata). Он выполняет перебор всех объектов CLR heap, ищет объекты типа `KeePassLib.PwDatabase`. Если такой объект обнаружен, извлекается путь к базе данных из поля `m_strUrl`. Затем метод анализирует все ссылки и объекты, связанные с базой данных, в поисках объекта `KeePassLib.Keys.CompositeKey`.

2. **Извлечение информации о ключах:** Как только объект составного ключа обнаружен, извлекается информация о различных типах ключей (например, `KcpPassword`, `KcpKeyFile`, `KcpUserAccount`). Эта информация включает зашифрованные двоичные данные ключей, которые обычно хранятся в памяти.

3. **Внедрение шелл-кода:** Для расшифровки зашифрованных данных ключей KeeTheft внедряет шелл-код в процесс KeePass. Этот шелл-код вызывает функцию `MyRtlDecryptMemory()`, которая используется для расшифровки данных в памяти.

4. **Извлечение ключевых данных:** После выполнения шелл-кода данные ключей расшифровываются и возвращаются в открытом текстовом виде, что позволяет злоумышленникам получить доступ к сохраненным паролям и другим секретным данным, хранимым в KeePass.

**Common Language Runtime Metadata (CLR MD)** - это библиотека, которая предоставляет доступ и анализ метаданных и структур данных.

## Описание правила

Правило "Keepass_Key_Dump_Via_KeeThief" предназначено для выявления попыток кражи ключевых данных из менеджера паролей KeePass с использованием инструмента KeeThief и PowerShell.

### Событие KeepassRemoteThread

Это событие используется для выявления remote threads в контексте процесса KeePass.

- `key`: Определяет ключ, основанный на хосте, на котором произошло событие.
- `filter`: Задаются условия фильтрации, которые должны быть выполнены. В данной части фильтра:
  - `filter::NotFromCorrelator()`: Условие означает, что событие не должно быть отправлено коррелятором.
  - `event_src.title == "sysmon"`: Событие должно иметь заголовок "sysmon".
  - `msgid == "8"`: Значение `msgid` должно быть равным "8".
  - `lower(object.process.name) == "keepass.exe"`: Имя процесса (`object.process.name`) должно быть равным "keepass.exe" в нижнем регистре. Это связано с тем, что мы ищем события в процессе keepass.exe.

### Событие KeeThief_Powershell_Command

Это событие служит для выявления выполнения команд PowerShell, связанных с инструментом KeeThief. Это может указывать на попытку использования KeeThief через PowerShell.

- `key`: Опять же, задает ключ события на основе хоста.
- `filter`: В этой части фильтра:
  - `filter::NotFromCorrelator()`: Событие не должно быть отправлено коррелятором.
  - `event_src.title == "windows"`: Заголовок события должен быть "windows".
  - `msgid == "4104"`: `msgid` должен быть равен "4104", что, вероятно, указывает на выполнение команды PowerShell.
  - `action == "execute"`: Действие, связанное с событием, должно быть "execute".
  - `regex(lower(object.process.cmdline), "getmethod('getkeepassmasterkeys').invoke", 0) != null`: Это сложное условие, которое проверяет, что командная строка (`object.process.cmdline`) содержит определенную строку, связанную с вызовом метода `getkeepassmasterkeys`.
